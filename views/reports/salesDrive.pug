doctype html
html(lang="uk")
  head
    meta(charset="UTF-8")
    meta(name="viewport", content="width=device-width, initial-scale=1.0")
    title Звіт SalesDrive
    link(rel="stylesheet", href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css")
  body
    if alerts && alerts.length
      .position-fixed(style="top: 1rem; right: 1rem; z-index: 1080; width: 320px;")
        each alertMessage in alerts
          .alert.alert-danger.alert-dismissible.fade.show(role="alert")
            span= alertMessage
            button.close(type="button", data-dismiss="alert", aria-label="Close")
              span(aria-hidden="true") &times;
    .container-fluid
      .d-flex.justify-content-between.align-items-center.mt-4
        h1.mb-0.text-primary Звіт SalesDrive
        a.btn.btn-outline-secondary(href="/") До вибору звітів
      p.text-muted.mt-2.mb-4
        | Період:
        strong #{startDate} – #{endDate}

      if rateLimitMeta
        - const minuteLimit = rateLimitMeta.minuteLimit
        - const minuteIntervalSeconds = rateLimitMeta.minuteIntervalSeconds
        - const hourlyLimit = rateLimitMeta.hourlyLimit
        - const hourlyUsed = hourlyStats && typeof hourlyStats.used === 'number' ? hourlyStats.used : 0
        - const hourlyRemaining = hourlyStats && typeof hourlyStats.remaining === 'number' ? hourlyStats.remaining : Math.max(hourlyLimit - hourlyUsed, 0)
        - const hourlyResetMs = hourlyStats && typeof hourlyStats.resetInMs === 'number' ? hourlyStats.resetInMs : 0
        - const hourlyResetSeconds = Math.max(Math.ceil(hourlyResetMs / 1000), 0)
        - const hourlyResetMinutes = Math.floor(hourlyResetSeconds / 60)
        - const hourlyResetSecs = hourlyResetSeconds % 60
        .alert.alert-info(role="alert")
          | SalesDrive: #{minuteLimit} запитів / #{minuteIntervalSeconds} с та #{hourlyLimit} запитів / годину.
          br
          | Використано #{hourlyUsed}, залишилось #{hourlyRemaining}. Оновлення квоти через #{hourlyResetMinutes} хв #{hourlyResetSecs} с.

      form.form-inline.mb-4(action="/reports/salesdrive", method="get")
        .form-group.mr-2
          label.sr-only(for="startDate") Початок
          input#startDate.form-control(type="date", name="startDate", value=startDate, max=endDate)
        .form-group.mr-2
          label.sr-only(for="endDate") Кінець
          input#endDate.form-control(type="date", name="endDate", value=endDate, min=startDate)
        .form-group.mr-2
          label.sr-only(for="source") Джерело продажу
          select#source.form-control(name="source", multiple, size="6")
            if salesDriveIstocniki
              each source in salesDriveIstocniki
                - const isSelected = Array.isArray(selectedSources) ? selectedSources.includes(source.id.toString()) : false
                option(value=source.id, selected=isSelected)= `${source.ident} (${source.name || source.id})`
            else
              option(value="", selected=false) Джерела не налаштовані
        button.btn.btn-primary(type="submit") Оновити
        a.btn.btn-outline-secondary.ml-2(href="/reports/salesdrive") Скинути
        if salesDriveLimit
          input(type="hidden", name="limit", value=salesDriveLimit)

      if rateLimitCooldown
        .alert.alert-warning
          | CRM тимчасово обмежила частоту запитів. Орієнтовний час очікування: #{rateLimitCooldownSeconds || '—'} с.

      if salesDriveTotals
        - const totalPayment = typeof salesDriveTotals.totalPaymentAmount === 'number' ? salesDriveTotals.totalPaymentAmount.toFixed(2) : salesDriveTotals.totalPaymentAmount
        - const totalCost = typeof salesDriveTotals.totalCostPriceAmount === 'number' ? salesDriveTotals.totalCostPriceAmount.toFixed(2) : salesDriveTotals.totalCostPriceAmount
        - const totalProfit = typeof salesDriveTotals.totalProfitAmount === 'number' ? salesDriveTotals.totalProfitAmount.toFixed(2) : salesDriveTotals.totalProfitAmount
        - const totalOrders = typeof salesDriveTotals.totalTransactions === 'number' ? salesDriveTotals.totalTransactions : salesDriveTotals.totalTransactions
        .row.mt-4
          .col-md-3.col-sm-6.mb-3
            .card.shadow-sm.border-0
              .card-body
                small.text-uppercase.text-muted Виручка
                h4.mb-0= totalPayment
          .col-md-3.col-sm-6.mb-3
            .card.shadow-sm.border-0
              .card-body
                small.text-uppercase.text-muted Собівартість
                h4.mb-0= totalCost
          .col-md-3.col-sm-6.mb-3
            .card.shadow-sm.border-0
              .card-body
                small.text-uppercase.text-muted Прибуток
                h4.mb-0= totalProfit
          .col-md-3.col-sm-6.mb-3
            .card.shadow-sm.border-0
              .card-body
                small.text-uppercase.text-muted Замовлення
                h4.mb-0= totalOrders

      if sourceSummaries && sourceSummaries.length
        h3.mt-4.text-secondary Деталізація за джерелами
        .table-responsive.mt-2
          table.table.table-striped.table-bordered
            thead.thead-dark
              tr
                th Джерело
                th Продажі (грн)
                th Прибуток (грн)
                th Собівартість (грн)
                th Замовлення
            tbody
              each sourceSummary in sourceSummaries
                - const sourcePayment = sourceSummary.salesTotals && typeof sourceSummary.salesTotals.totalPaymentAmount === 'number' ? sourceSummary.salesTotals.totalPaymentAmount.toFixed(2) : (sourceSummary.salesTotals && sourceSummary.salesTotals.totalPaymentAmount !== undefined ? sourceSummary.salesTotals.totalPaymentAmount : '-')
                - const sourceProfit = sourceSummary.salesTotals && typeof sourceSummary.salesTotals.totalProfitAmount === 'number' ? sourceSummary.salesTotals.totalProfitAmount.toFixed(2) : (sourceSummary.salesTotals && sourceSummary.salesTotals.totalProfitAmount !== undefined ? sourceSummary.salesTotals.totalProfitAmount : '-')
                - const sourceCost = sourceSummary.salesTotals && typeof sourceSummary.salesTotals.totalCostPriceAmount === 'number' ? sourceSummary.salesTotals.totalCostPriceAmount.toFixed(2) : (sourceSummary.salesTotals && sourceSummary.salesTotals.totalCostPriceAmount !== undefined ? sourceSummary.salesTotals.totalCostPriceAmount : '-')
                - const sourceOrders = sourceSummary.salesTotals && sourceSummary.salesTotals.totalTransactions !== undefined ? sourceSummary.salesTotals.totalTransactions : '-'
                tr
                  td= sourceSummary.name || sourceSummary.ident
                  td= sourcePayment
                  td= sourceProfit
                  td= sourceCost
                  td= sourceOrders

      h3.mt-5.text-secondary Замовлення
      .table-responsive.mt-3
        table.table.table-striped.table-bordered
          thead.thead-dark
            tr
              th Order ID
              th Customer
              th Order Time
              th Products
              th Status
              th Total Cost
              th Source Ident
          tbody
            if salesDriveData && salesDriveData.length
              each item in salesDriveData
                tr
                  td= item.id
                  td= `${item.fName} ${item.lName}`.trim()
                  td= item.orderTime
                  td= item.products
                  td= item.statusName
                  td= item.totalCost
                  td= item.istocnikProdaziIdent
            else
              tr
                td(colspan="7").text-center Даних не знайдено

    script(src="https://code.jquery.com/jquery-3.5.1.slim.min.js")
    script(src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js")
    script(src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js")
