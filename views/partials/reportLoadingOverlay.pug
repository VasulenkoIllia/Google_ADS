mixin reportLoadingOverlay(meta = {}, options = {})
  - const overlayId = options && options.id ? options.id : 'reportLoadingOverlay';
  - const waitSeconds = Number.isFinite(meta.waitSeconds) ? meta.waitSeconds : null;
  - const queueAhead = Number.isFinite(meta.queueAhead) ? meta.queueAhead : null;
  - const estimatedTotal = Number.isFinite(meta.estimatedTotalRequests) ? meta.estimatedTotalRequests : (queueAhead !== null ? queueAhead : null);
  - const remainingSources = Number.isFinite(meta.remainingSources) ? meta.remainingSources : null;
  - const rateLimitMeta = meta.rateLimitMeta || {};
  - const minuteLimit = Number.isFinite(rateLimitMeta.minuteLimit) ? rateLimitMeta.minuteLimit : null;
  - const intervalSeconds = Number.isFinite(rateLimitMeta.minuteIntervalSeconds) ? rateLimitMeta.minuteIntervalSeconds : null;
  - const hourlyLimit = Number.isFinite(rateLimitMeta.hourlyLimit) ? rateLimitMeta.hourlyLimit : null;
  - const dailyLimit = Number.isFinite(rateLimitMeta.dailyLimit) ? rateLimitMeta.dailyLimit : null;
  - const hourlyRemaining = Number.isFinite(meta.hourlyRemaining) ? meta.hourlyRemaining : null;
  - const hourlyResetSeconds = Number.isFinite(meta.hourlyResetSeconds) ? meta.hourlyResetSeconds : null;
  - const dailyRemaining = Number.isFinite(meta.dailyRemaining) ? meta.dailyRemaining : null;
  - const dailyResetSeconds = Number.isFinite(meta.dailyResetSeconds) ? meta.dailyResetSeconds : null;
  - const overlayClasses = ['report-loading-overlay'];
  - const autoShow = !!(options && options.autoShow);
  - const overlayReloadUrl = options && options.reloadUrl ? options.reloadUrl : (meta.reloadUrl || '');
  - const sourceIdent = typeof meta.sourceIdent === 'string' && meta.sourceIdent.trim().length ? meta.sourceIdent.trim() : null;
  - const overlayMessage = typeof meta.message === 'string' && meta.message.trim().length ? meta.message : 'CRM обрабатывает запросы. Пожалуйста, подождите.';
  - if (autoShow) {
  -   overlayClasses.push('active');
  - }

  style.
    .report-loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(248, 249, 250, 0.94);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1050;
      padding: 1.5rem;
    }
    .report-loading-overlay.active {
      display: flex;
    }
    .report-loading-card {
      max-width: 380px;
      width: 100%;
    }
  .report-loading-overlay(
    id=overlayId
    class=overlayClasses.join(' ')
    data-wait=waitSeconds !== null ? waitSeconds : ''
    data-reload=overlayReloadUrl || ''
    data-auto-show=autoShow ? 'true' : 'false'
  )
    .card.shadow.report-loading-card
      .card-body
        div.spinner-border.text-primary.mb-3(role="status")
          span.sr-only Загрузка…
        h2.h5.mb-2 Готовим отчёт
        p.text-muted.mb-3= overlayMessage
        ul.list-unstyled.text-left.small.mb-0
          li
            strong Ориентировочное время:&nbsp;
            if waitSeconds !== null
              span(data-overlay-countdown=waitSeconds)= `${waitSeconds} с`
            else
              span(data-overlay-countdown) — 
          li
            strong Запросов в очереди:&nbsp;
            span= estimatedTotal !== null ? estimatedTotal : '—'
            if remainingSources !== null
              span &nbsp;•&nbsp;Источников: #{remainingSources}
          if sourceIdent
            li
              strong Текущий источник:&nbsp;
              span= sourceIdent
          if minuteLimit !== null && intervalSeconds !== null
            li Пропускная способность CRM: #{minuteLimit} запросов / #{intervalSeconds} с.
          if hourlyLimit !== null
            li
              span Часовой лимит: #{hourlyLimit}
              span &nbsp;•&nbsp;Осталось: #{hourlyRemaining !== null ? hourlyRemaining : '—'}
              if hourlyResetSeconds !== null
                - const hrMinutes = Math.floor(hourlyResetSeconds / 60);
                - const hrSeconds = hourlyResetSeconds % 60;
                span &nbsp;•&nbsp;Обновление через #{hrMinutes} мин #{hrSeconds} с
          if dailyLimit !== null
            li
              span Суточный лимит: #{dailyLimit}
              span &nbsp;•&nbsp;Осталось: #{dailyRemaining !== null ? dailyRemaining : '—'}
              if dailyResetSeconds !== null
                - const dayHours = Math.floor(dailyResetSeconds / 3600);
                - const dayMinutes = Math.floor((dailyResetSeconds % 3600) / 60);
                span &nbsp;•&nbsp;Обновление через #{dayHours} ч #{dayMinutes} мин
  script.
    (function() {
      if (window.__reportOverlayInit) {
        return;
      }
      window.__reportOverlayInit = true;
      document.addEventListener('DOMContentLoaded', function () {
        var overlay = document.getElementById('#{overlayId}');
        if (!overlay) {
          return;
        }
        var countdownStarted = false;
        var countdownTimer = null;
        var resetOverlayState = function () {
          overlay.classList.remove('active');
          if (countdownTimer) {
            clearInterval(countdownTimer);
            countdownTimer = null;
          }
          countdownStarted = false;
        };
        window.addEventListener('pageshow', function (event) {
          var navigationEntry = (performance && performance.getEntriesByType) ? performance.getEntriesByType('navigation')[0] : null;
          var isBackNavigation = (navigationEntry && navigationEntry.type === 'back_forward') || event.persisted === true;
          if (isBackNavigation) {
            resetOverlayState();
          }
        });
        var startCountdown = function () {
          if (countdownStarted) {
            return;
          }
          var waitAttr = overlay.getAttribute('data-wait');
          var reloadTarget = overlay.getAttribute('data-reload');
          var countdownEl = overlay.querySelector('[data-overlay-countdown]');
          var waitValue = parseInt(waitAttr, 10);
          if (!countdownEl || !Number.isFinite(waitValue) || waitValue <= 0) {
            return;
          }
          countdownStarted = true;
          var remaining = waitValue;
          countdownEl.textContent = remaining + ' с';
          countdownTimer = setInterval(function () {
            remaining -= 1;
            if (remaining <= 0) {
              clearInterval(countdownTimer);
              countdownTimer = null;
              if (reloadTarget) {
                window.location.href = reloadTarget;
              } else {
                window.location.reload();
              }
              return;
            }
            countdownEl.textContent = remaining + ' с';
          }, 1000);
        };
        var showOverlay = function () {
          if (!overlay) {
            return;
          }
          overlay.classList.add('active');
          startCountdown();
        };
        document.querySelectorAll('[data-report-link]').forEach(function (linkEl) {
          var target = (linkEl.getAttribute('data-overlay-target') || '').toLowerCase();
          if (target === 'heavy') {
            linkEl.addEventListener('click', function (event) {
              if (event.defaultPrevented) {
                return;
              }
              if (event.metaKey || event.ctrlKey || event.shiftKey || event.button !== 0) {
                return;
              }
              var href = linkEl.getAttribute('href');
              if (!href) {
                return;
              }
              event.preventDefault();
              showOverlay();
              requestAnimationFrame(function () {
                window.location.href = href;
              });
            });
          }
        });
        document.querySelectorAll('form[data-report-form]').forEach(function (formEl) {
          var target = (formEl.getAttribute('data-overlay-target') || '').toLowerCase();
          if (target === 'heavy') {
            formEl.addEventListener('submit', function (event) {
              if (event.defaultPrevented) {
                return;
              }
              event.preventDefault();
              showOverlay();
              requestAnimationFrame(function () {
                HTMLFormElement.prototype.submit.call(formEl);
              });
            });
          }
        });
        if (overlay.getAttribute('data-auto-show') === 'true') {
          showOverlay();
        }
      });
    })();
